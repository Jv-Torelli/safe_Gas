<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/dash_especifica.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.1.1/dist/chartjs-plugin-annotation.min.js"></script>
  <title>Dashboard Específica</title>
</head>

<body onload="grafico_de_linha(); configurarNavbarPorTipoUsuario();">

  <div class="main">
    <div class="navbar">
      <div class="welcome_navbar">
        <img src="../assets/img_site_institucional/logoSafeGas.png" alt="">
      </div>

      <div class="container_btn">
        <a href="./DashboardOFC.html" class="btnNavbar">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
            fill="currentcolor">
            <path
              d="M120-120v-80l80-80v160h-80Zm160 0v-240l80-80v320h-80Zm160 0v-320l80 81v239h-80Zm160 0v-239l80-80v319h-80Zm160 0v-400l80-80v480h-80ZM120-327v-113l280-280 160 160 280-280v113L560-447 400-607 120-327Z" />
          </svg>

          Dashboard geral
        </a>
        <a href="./dash_portarias.html" class="btnNavbar" id="portaria">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
            fill="currentcolor">
            <path
              d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q14-36 44-58t68-22q38 0 68 22t44 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm280-670q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-246q54-53 125.5-83.5T480-360q83 0 154.5 30.5T760-246v-514H200v514Zm280-194q58 0 99-41t41-99q0-58-41-99t-99-41q-58 0-99 41t-41 99q0 58 41 99t99 41ZM280-200h400v-10q-42-35-93-52.5T480-280q-56 0-107 17.5T280-210v10Zm200-320q-25 0-42.5-17.5T420-580q0-25 17.5-42.5T480-640q25 0 42.5 17.5T540-580q0 25-17.5 42.5T480-520Zm0 17Z" />
          </svg>

          Portaria
        </a>
      </div>

      <div class="btnNavbar" id="logout"> <img src="../assets/icons_navbar/Logout.png"> Logout</div>

    </div>

    <main class="painel">
      <div class="container_superior">
        <div class="div_kpi indicador_acao">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_acao.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Ação Rápida</span>
            <span class="span_resposta" id="span_alerta_acao"></span>
          </div>
        </div>

        <div class="div_kpi indicador_status">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_status.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Status de Alerta</span>
            <span class="span_resposta span_alerta_status"></span>
          </div>
        </div>

        <div class="div_kpi indicador_local">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_local.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">No Local</span>
            <span class="span_resposta" id="span_local_medicaoMaior"></span>
          </div>
        </div>

        <div class="div_kpi indicador_hora">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_atualizacao.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Última Atualização</span>

            <span class="span_resposta" id="span_dataHora"></span>
          </div>
        </div>

      </div>

      <div class="container_inferior">
        <div class="div_grafico">
          <div class="div_nivel">
            <span class="span_titulo">Nivel de Gás</span>
            <span class="span_identificacao">Torre <span id="span_bloco_predio"></span>, Apto <span
                id="span_numero_apartamento"></span>, <span id="span_sensor_local_selecionado"></span></span>
            <hr>
            <canvas id="canvas_grafico"></canvas>
          </div>
        </div>

        <div class="div_sensores">
          <div class="div_alerta">

            <div class="div_status_alerta">
              <div class="div_img_alerta">
                <img src="../assets/dashEspecifica/icon_alerta.png" alt="">
              </div>
              <div class="div_sobre_alerta">
                <span class="span_titulo">Alerta de Risco<span class="span_alerta_status"></span></span>

                <span class="span_subtitulo" id="span_alerta_risco"></span>
              </div>
            </div>

          </div>
          <div class="div_medicao">
            <div class="div_titulo_medicao">
              <span class="span_titulo">Sensores</span>
              <span class="span_subtitulo">NIVEL DE GÁS (%)</span>
            </div>
            <hr>

            <div class="div_sensores_medicao">
              <div class="div_opcao_sensor">
                <span class="span_sensor" id="span_local_sensor1">--------</span>
                <span class="span_medicao" id="span_medicao1">--------</span>
                <button class="btn_sensor" id="btn_sensor1">Ver Gráfico</button>
              </div>
              <hr>

              <div class="div_opcao_sensor">
                <span class="span_sensor" id="span_local_sensor2">--------</span>
                <span class="span_medicao" id="span_medicao2">--------</span>
                <button class="btn_sensor" id="btn_sensor2">Ver Gráfico</button>
              </div>
              <hr>

              <div class="div_opcao_sensor">
                <span class="span_sensor" id="span_local_sensor3">--------</span>
                <span class="span_medicao" id="span_medicao3">--------</span>
                <button class="btn_sensor" id="btn_sensor3">Ver Gráfico</button>
              </div>

            </div>
          </div>
        </div>
      </div>

  </div>
  </main>

</body>

</html>
<script>

  let chart;
  const idSensor = 1;
  let ultimaAtualizacao = new Date(); // Variável para armazenar a última atualização

  const dadosSensores = {
    1: { nome: 'Cozinha', medicao: 0, local: 'Torre A, Apto 101' },
    2: { nome: 'Sala', medicao: 0, local: 'Torre A, Apto 101' },
    3: { nome: 'Banheiro', medicao: 0, local: 'Torre A, Apto 101' }
  };


  const dadosHistoricosSensores = {
    2: { labels: [], valores: [] },
    3: { labels: [], valores: [] }
  };

  let sensorAtualGrafico = 1;


  const niveisAlerta = {
    'Seguro': {
      status: 'Seguro',
      risco: 'Nenhum risco',
      acao: 'Nenhuma ação necessária'
    },
    'Atenção': {
      status: 'Atenção',
      risco: 'Possível vazamento',
      acao: 'Ventilar o apartamento'
    },
    'Perigo': {
      status: 'Perigo',
      risco: 'Possibilidade de explosão',
      acao: 'Evacuar o local imediatamente'
    },
    'Emergência': {
      status: 'Emergência',
      risco: 'Possibilidade de asfixia',
      acao: 'Ligar para os bombeiros'
    }
  };

  function configurarNavbarPorTipoUsuario() {
    const tipoUsuario = sessionStorage.getItem('TIPO_USUARIO');

    if (!tipoUsuario) {
      console.warn('Tipo de usuário não encontrado na sessão');
      setTimeout(() => {
        window.location.href = '../login.html';
      }, 2000);
      return;
    }

    console.log('Tipo de usuário logado:', tipoUsuario);

    const btnPortaria = document.getElementById('portaria');
    if (!btnPortaria) {
      console.warn('Elemento portaria não encontrado');
      return;
    }

    if (tipoUsuario === 'porteiro') {
      btnPortaria.style.setProperty('display', 'none', 'important');
    } else if (tipoUsuario === 'sindico') {
      btnPortaria.style.setProperty('display', 'flex', 'important');
    }
  }


  function atualizarUltimaAtualizacao() {
    ultimaAtualizacao = new Date();
    const spanDataHora = document.getElementById('span_dataHora');
    if (spanDataHora) {
      spanDataHora.textContent = formatarDataHora(ultimaAtualizacao);
    }
  }

  async function obterDadosKpi(idSensor) {
    fetch(`/especifica/kpi/${idSensor}`)
      .then(response => response.json())
      .then(resultado => {
        if (resultado.sucesso) {
          const dados = resultado.dados;

          if (dados && dados.length > 0) {
            const ultimoDado = dados[0];

            atualizarKpisPorMaiorMedicao();

            
            if (ultimoDado['Data e hora da medição']) {
              ultimaAtualizacao = new Date(ultimoDado['Data e hora da medição']);
            } else {
              ultimaAtualizacao = new Date();
            }
            atualizarUltimaAtualizacao();

            const spanBloco = document.getElementById('span_bloco_predio');
            const spanApto = document.getElementById('span_numero_apartamento');
            if (spanBloco) spanBloco.textContent = 'A';
            if (spanApto) spanApto.textContent = '101';
          }
        } else {
          console.error('Erro ao carregar dados:', resultado.mensagem);
          usarDadosSimulados();
        }
      })
      .catch(erro => {
        console.error('Erro na requisição:', erro);
        usarDadosSimulados();
      });
  }

  function usarDadosSimulados() {

    atualizarUltimaAtualizacao();

    const spanBloco = document.getElementById('span_bloco_predio');
    const spanApto = document.getElementById('span_numero_apartamento');
    if (spanBloco) spanBloco.textContent = 'A';
    if (spanApto) spanApto.textContent = '101';

    atualizarKpisPorMaiorMedicao();
  }

  function obterSensorComMaiorMedicao() {
    let maiorMedicao = -1;
    let sensorComMaiorMedicao = 1;

    for (let i = 1; i <= 3; i++) {
      if (dadosSensores[i].medicao > maiorMedicao) {
        maiorMedicao = dadosSensores[i].medicao;
        sensorComMaiorMedicao = i;
      }
    }

    return {
      id: sensorComMaiorMedicao,
      medicao: maiorMedicao,
      sensor: dadosSensores[sensorComMaiorMedicao]
    };
  }

  function atualizarKpisPorMaiorMedicao() {
    const sensorMaior = obterSensorComMaiorMedicao();
    const nivelStatus = obterStatusPorMedicao(sensorMaior.medicao);
    const alertaInfo = niveisAlerta[nivelStatus];

    const spansStatus = document.querySelectorAll('.span_alerta_status');
    spansStatus.forEach(span => {
      span.textContent = ` ${alertaInfo.status}`;
    });


    const spanAcao = document.getElementById('span_alerta_acao');
    if (spanAcao) {
      spanAcao.textContent = alertaInfo.acao;
    }


    const spanLocal = document.getElementById('span_local_medicaoMaior');
    if (spanLocal) {
      spanLocal.textContent = sensorMaior.sensor.nome;
    }


    atualizarAlertaRiscoPorSensorSelecionado();
  }

  function atualizarAlertaRiscoPorSensorSelecionado() {
    const sensorSelecionado = dadosSensores[sensorAtualGrafico];
    const nivelStatus = obterStatusPorMedicao(sensorSelecionado.medicao);
    const alertaInfo = niveisAlerta[nivelStatus];

    const spanAlertaRisco = document.getElementById('span_alerta_risco');
    if (spanAlertaRisco) {
      spanAlertaRisco.textContent = `${alertaInfo.risco} - ${sensorSelecionado.nome} (${sensorSelecionado.medicao.toFixed(2)}%)`;
    }
  }

  function obterStatusPorMedicao(medicao) {
    if (medicao <= 2.4) {
      return 'Seguro';
    } else if (medicao <= 4.9) {
      return 'Atenção';
    } else if (medicao <= 14.9) {
      return 'Perigo';
    } else {
      return 'Emergência';
    }
  }

  function formatarDataHora(dataHora) {
    if (!dataHora) return 'N/A';

    const data = new Date(dataHora);
    
    // Verificar se a data é válida
    if (isNaN(data.getTime())) {
      return 'N/A';
    }
    
    return data.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }


  function obterDadosGrafico(idSensor) {
    fetch(`/especifica/grafico/${idSensor}`)
      .then(response => response.json())
      .then(resultado => {
        if (resultado.sucesso) {
          const dados = resultado.dados;

          if (dados && dados.length > 0) {
            const labels = dados.map(item => formatarHora(item['Data e hora']));
            const valores = dados.map(item => parseFloat(item['Nível de Gás']) || 0);

            atualizarGraficoLinha(labels, valores);
            atualizarInfoSensorGrafico(idSensor);

            if (valores.length > 0) {
              dadosSensores[idSensor].medicao = valores[valores.length - 1];
              atualizarDisplaySensores();
              atualizarKpisPorMaiorMedicao();
            }
            
            // Atualizar horário da última atualização quando dados são recebidos
            atualizarUltimaAtualizacao();
          }
        } else {
          console.error('Erro ao carregar gráfico:', resultado.mensagem);
        }
      })
      .catch(erro => {
        console.error('Erro ao carregar gráfico:', erro);

        const dados = gerarDadosAleatorios(dadosSensores[idSensor].nome);
        atualizarGraficoLinha(dados.labels, dados.valores);
        atualizarInfoSensorGrafico(idSensor);

        if (dados.valores.length > 0) {
          dadosSensores[idSensor].medicao = dados.valores[dados.valores.length - 1];
        }
        
        // Atualizar horário da última atualização mesmo com dados simulados
        atualizarUltimaAtualizacao();
      });
  }


  function gerarDadosAleatorios(nomeSensor) {
    const agora = new Date();
    const labels = [];
    const valores = [];


    for (let i = 19; i >= 0; i--) {
      const tempo = new Date(agora.getTime() - (i * 6 * 60000));
      labels.push(formatarHora(tempo));

      let valor;


      if (nomeSensor === 'Sala' || nomeSensor === 'Banheiro') {
        valor = Math.random() * 2.3 + 0.1;
      } else {
        let valorBase = 3;
        let variacao = 5;
        valor = Math.random() * variacao + valorBase;
      }

      valores.push(parseFloat(valor.toFixed(2)));
    }

    return { labels, valores };
  }


  function atualizarDadosSensoresAutomaticos(idSensor) {
    const agora = new Date();
    const novoLabel = formatarHora(agora);

    let novoValor;
    const nomeSensor = dadosSensores[idSensor].nome;


    if (nomeSensor === 'Sala' || nomeSensor === 'Banheiro') {

      novoValor = parseFloat((Math.random() * 2.3 + 0.1).toFixed(2));
    } else {

      let valorBase = 14;
      let variacao = 5;
      novoValor = parseFloat((Math.random() * variacao + valorBase).toFixed(2));
    }


    const dadosHistoricos = dadosHistoricosSensores[idSensor];
    dadosHistoricos.labels.push(novoLabel);
    dadosHistoricos.valores.push(novoValor);


    if (dadosHistoricos.labels.length > 20) {
      dadosHistoricos.labels.shift();
      dadosHistoricos.valores.shift();
    }


    dadosSensores[idSensor].medicao = novoValor;

    return {
      labels: [...dadosHistoricos.labels],
      valores: [...dadosHistoricos.valores]
    };
  }

  function atualizarGraficoLinha(labels, valores) {
    const ctx = document.getElementById('canvas_grafico').getContext('2d');

    if (chart) {
      chart.destroy();
    }

    const data = {
      labels: labels,
      datasets: [{
        label: 'Nível de Gás (%)',
        data: valores,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }]
    };

    const config = {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: Math.max(Math.max(...valores) + 2, 20)
          }
        },
        plugins: {
          legend: {
            display: true
          }
        }
      }
    };

    chart = new Chart(ctx, config);
  }

  function atualizarInfoSensorGrafico(idSensor) {
    const spanSensorLocal = document.getElementById('span_sensor_local_selecionado');
    if (spanSensorLocal) {
      spanSensorLocal.textContent = dadosSensores[idSensor].nome;
    }
    sensorAtualGrafico = idSensor;
    atualizarKpisPorMaiorMedicao();
    atualizarAlertaRiscoPorSensorSelecionado();
  }

  function definirCorBotao(medicao) {
    if (medicao <= 2.4) {
      return 'verde';
    } else if (medicao <= 4.9) {
      return 'amarelo';
    } else if (medicao <= 14.9) {
      return 'vermelho';
    } else {
      return 'preto';
    }
  }

  function aplicarCorBotao(elemento, cor) {
    switch (cor) {
      case 'verde':
        elemento.style.backgroundColor = '#28a745';
        elemento.style.color = 'white';
        elemento.style.border = '2px solid #28a745';
        break;
      case 'amarelo':
        elemento.style.backgroundColor = '#ffc107';
        elemento.style.color = 'black';
        elemento.style.border = '2px solid #ffc107';
        break;
      case 'vermelho':
        elemento.style.backgroundColor = '#dc3545';
        elemento.style.color = 'white';
        elemento.style.border = '2px solid #dc3545';
        break;
      case 'preto':
        elemento.style.backgroundColor = '#000000';
        elemento.style.color = 'white';
        elemento.style.border = '2px solid #000000';
        break;
    }
  }

  function atualizarDisplaySensores() {
    for (let i = 1; i <= 3; i++) {
      const spanLocal = document.getElementById(`span_local_sensor${i}`);
      const spanMedicao = document.getElementById(`span_medicao${i}`);
      const btnSensor = document.getElementById(`btn_sensor${i}`);

      if (spanLocal && spanMedicao && btnSensor) {
        const sensor = dadosSensores[i];

        spanLocal.textContent = sensor.nome;
        spanMedicao.textContent = `${sensor.medicao.toFixed(2)}%`;

        const cor = definirCorBotao(sensor.medicao);
        aplicarCorBotao(btnSensor, cor);

        btnSensor.classList.remove('ativo');

        if (i === sensorAtualGrafico) {
          btnSensor.classList.add('ativo');
          btnSensor.textContent = 'Gráfico Atual';
        } else {
          btnSensor.textContent = 'Ver Gráfico';
        }
      }
    }
  }

  function configurarBotoesSensores() {

    document.getElementById('btn_sensor1').addEventListener('click', function () {
      sensorAtualGrafico = 1;
      obterDadosGrafico(1);
      atualizarDisplaySensores();
      atualizarKpisPorMaiorMedicao();
      atualizarAlertaRiscoPorSensorSelecionado();
    });


    document.getElementById('btn_sensor2').addEventListener('click', function () {
      sensorAtualGrafico = 2;


      if (dadosHistoricosSensores[2].labels.length === 0) {
        const dados = gerarDadosAleatorios('Sala');
        dadosHistoricosSensores[2].labels = dados.labels;
        dadosHistoricosSensores[2].valores = dados.valores;
        dadosSensores[2].medicao = dados.valores[dados.valores.length - 1];
      }

      atualizarGraficoLinha(dadosHistoricosSensores[2].labels, dadosHistoricosSensores[2].valores);
      atualizarInfoSensorGrafico(2);
      atualizarDisplaySensores();
      atualizarKpisPorMaiorMedicao();
      atualizarAlertaRiscoPorSensorSelecionado();
      
      // Atualizar horário da última atualização
      atualizarUltimaAtualizacao();
    });


    document.getElementById('btn_sensor3').addEventListener('click', function () {
      sensorAtualGrafico = 3;


      if (dadosHistoricosSensores[3].labels.length === 0) {
        const dados = gerarDadosAleatorios('Banheiro');
        dadosHistoricosSensores[3].labels = dados.labels;
        dadosHistoricosSensores[3].valores = dados.valores;
        dadosSensores[3].medicao = dados.valores[dados.valores.length - 1];
      }

      atualizarGraficoLinha(dadosHistoricosSensores[3].labels, dadosHistoricosSensores[3].valores);
      atualizarInfoSensorGrafico(3);
      atualizarDisplaySensores();
      atualizarKpisPorMaiorMedicao();
      atualizarAlertaRiscoPorSensorSelecionado();
      
      // Atualizar horário da última atualização
      atualizarUltimaAtualizacao();
    });
  }


  function inicializarSensoresAutomaticos() {

    const dadosSala = gerarDadosAleatorios('Sala');
    dadosHistoricosSensores[2].labels = dadosSala.labels;
    dadosHistoricosSensores[2].valores = dadosSala.valores;
    dadosSensores[2].medicao = dadosSala.valores[dadosSala.valores.length - 1];


    const dadosBanheiro = gerarDadosAleatorios('Banheiro');
    dadosHistoricosSensores[3].labels = dadosBanheiro.labels;
    dadosHistoricosSensores[3].valores = dadosBanheiro.valores;
    dadosSensores[3].medicao = dadosBanheiro.valores[dadosBanheiro.valores.length - 1];
  }

  function iniciarAtualizacaoCompleta() {

    inicializarSensoresAutomaticos();

    // Inicializar o horário da última atualização
    atualizarUltimaAtualizacao();

    obterDadosKpi(1);
    obterDadosGrafico(1);


    configurarBotoesSensores();


    setTimeout(() => {
      atualizarDisplaySensores();
      atualizarKpisPorMaiorMedicao();
    }, 1000);


    setInterval(() => {

      obterDadosKpi(1);


      if (sensorAtualGrafico === 1) {

        obterDadosGrafico(1);
      } else if (sensorAtualGrafico === 2) {

        const novosData = atualizarDadosSensoresAutomaticos(2);
        atualizarGraficoLinha(novosData.labels, novosData.valores);
        atualizarUltimaAtualizacao(); // Atualizar horário
      } else if (sensorAtualGrafico === 3) {

        const novosData = atualizarDadosSensoresAutomaticos(3);
        atualizarGraficoLinha(novosData.labels, novosData.valores);
        atualizarUltimaAtualizacao(); // Atualizar horário
      }


      if (sensorAtualGrafico !== 2) {
        atualizarDadosSensoresAutomaticos(2);
      }
      if (sensorAtualGrafico !== 3) {
        atualizarDadosSensoresAutomaticos(3);
      }


      atualizarDisplaySensores();
      atualizarKpisPorMaiorMedicao();
      atualizarAlertaRiscoPorSensorSelecionado();
    }, 5000);
  }

  function formatarHora(dataHora) {
    const data = new Date(dataHora);
    return data.toLocaleTimeString('pt-BR', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function grafico_de_linha() {
    iniciarAtualizacaoCompleta();
  }


</script>