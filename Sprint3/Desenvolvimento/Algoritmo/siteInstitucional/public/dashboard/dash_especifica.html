<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/dash_especifica.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.1.1/dist/chartjs-plugin-annotation.min.js"></script>
  <title>Dashboard Específica</title>
</head>

<body onload="grafico_de_linha()">

  <div class="main">
    <div class="navbar">
      <div class="welcome_navbar">
        <img src="../assets/img_site_institucional/logoSafeGas.png" alt="">
      </div>

      <div class="container_btn">
        <a href="./DashboardOFC.html" class="btnNavbar">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
            fill="currentcolor">
            <path
              d="M120-120v-80l80-80v160h-80Zm160 0v-240l80-80v320h-80Zm160 0v-320l80 81v239h-80Zm160 0v-239l80-80v319h-80Zm160 0v-400l80-80v480h-80ZM120-327v-113l280-280 160 160 280-280v113L560-447 400-607 120-327Z" />
          </svg>

          Dashboard geral
        </a>
        <a href="./dash_portarias.html" class="btnNavbar">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
            fill="currentcolor">
            <path
              d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q14-36 44-58t68-22q38 0 68 22t44 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm280-670q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-246q54-53 125.5-83.5T480-360q83 0 154.5 30.5T760-246v-514H200v514Zm280-194q58 0 99-41t41-99q0-58-41-99t-99-41q-58 0-99 41t-41 99q0 58 41 99t99 41ZM280-200h400v-10q-42-35-93-52.5T480-280q-56 0-107 17.5T280-210v10Zm200-320q-25 0-42.5-17.5T420-580q0-25 17.5-42.5T480-640q25 0 42.5 17.5T540-580q0 25-17.5 42.5T480-520Zm0 17Z" />
          </svg>

          Portaria
        </a>
      </div>

      <div class="btnNavbar" id="logout"> <img src="../assets/icons_navbar/Logout.png"> Logout</div>

    </div>

    <main class="painel"> <!-- Painel do todo conteúdo -->
      <div class="container_superior">
        <div class="div_kpi indicador_acao">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_acao.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Ação Rápida</span> <!-- KPI Ação -->
            <span class="span_resposta" id="span_alerta_acao"></span>
          </div>
        </div>

        <div class="div_kpi indicador_status">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_status.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Status de Alerta</span> <!-- KPI Status de Alerta -->
            <span class="span_resposta span_alerta_status"></span>
          </div>
        </div>

        <div class="div_kpi indicador_local">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_local.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">No Local</span> <!-- KPI Local que está anormal e com maior nível de gás -->
            <span class="span_resposta" id="span_local_medicaoMaior"></span>
          </div>
        </div>

        <div class="div_kpi indicador_hora">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_atualizacao.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Última Atualização</span>
            <!-- KPI Última data e hora quando maior nível de gás -->
            <span class="span_resposta" id="span_dataHora"></span>
          </div>
        </div>

      </div>

      <div class="container_inferior">
        <div class="div_grafico">
          <div class="div_nivel">
            <span class="span_titulo">Nivel de Gás (Últimas 2h)</span>
            <span class="span_identificacao">Torre <span id="span_bloco_predio"></span>, Apto <span
                id="span_numero_apartamento"></span>, <span id="span_sensor_local_selecionado"></span></span>
            <hr>
            <canvas id="canvas_grafico"></canvas>
          </div>
        </div>

        <div class="div_sensores">
          <div class="div_alerta">

            <div class="div_status_alerta">
              <div class="div_img_alerta">
                <img src="../assets/dashEspecifica/icon_alerta.png" alt="">
              </div>
              <div class="div_sobre_alerta">
                <span class="span_titulo">Alerta de Risco<span class="span_alerta_status"></span></span>

                <span class="span_subtitulo" id="span_alerta_risco"></span>
              </div>
            </div>

          </div>
          <div class="div_medicao">
            <div class="div_titulo_medicao">
              <span class="span_titulo">Sensores</span>
              <span class="span_subtitulo">NIVEL DE GÁS (%)</span>
            </div>
            <hr>

            <div class="div_sensores_medicao">
              <div class="div_opcao_sensor">
                <span class="span_sensor" id="span_local_sensor1">--------</span>
                <span class="span_medicao" id="span_medicao1">--------</span>
                <button class="btn_sensor" id="btn_sensor1">Ver Gráfico</button>
              </div>
              <hr>

              <div class="div_opcao_sensor">
                <span class="span_sensor" id="span_local_sensor2">--------</span>
                <span class="span_medicao" id="span_medicao2">--------</span>
                <button class="btn_sensor" id="btn_sensor2">Ver Gráfico</button>
              </div>
              <hr>

              <div class="div_opcao_sensor">
                <span class="span_sensor" id="span_local_sensor3">--------</span>
                <span class="span_medicao" id="span_medicao3">--------</span>
                <button class="btn_sensor" id="btn_sensor3">Ver Gráfico</button>
              </div>

            </div>
          </div>
        </div>
      </div>

  </div>
  </main>

</body>

</html>
<script>
  let chart; 
  const idSensor = 1;

  async function obterDadosKpi(idSensor) {
    fetch(`/especifica/kpi/${idSensor}`)
        .then(response => response.json())
        .then(resultado => {
            if (resultado.sucesso) {
                const dados = resultado.dados;
                
                if (dados && dados.length > 0) {
                    const ultimoDado = dados[0]; 
                    
                
                    const spanAcao = document.getElementById('span_alerta_acao');
                    if (spanAcao) {
                        spanAcao.textContent = ultimoDado['Acao do usuario'] || 'Nenhuma ação';
                    }
                    
                  
                    const spansStatus = document.querySelectorAll('.span_alerta_status');
                    spansStatus.forEach(span => {
                        span.textContent = ultimoDado['Status do Alerta'] || 'Normal';
                    });
                    
                    
                    const spanLocal = document.getElementById('span_local_medicaoMaior');
                    if (spanLocal) {
                        spanLocal.textContent = ultimoDado['Local de instalação'] || 'N/A';
                    }
                    
                   
                    const spanDataHora = document.getElementById('span_dataHora');
                    if (spanDataHora) {
                        const dataHora = ultimoDado['Data e hora da medição'];
                        spanDataHora.textContent = formatarDataHora(dataHora);
                    }
                    
                  
                    const spanAlertaRisco = document.getElementById('span_alerta_risco');
                    if (spanAlertaRisco) {
                        spanAlertaRisco.textContent = `${ultimoDado['Status do Alerta']} - ${ultimoDado['Local de instalação']}`;
                    }
                }
            } else {
                console.error('Erro ao carregar dados:', resultado.mensagem);
            }
        })
        .catch(erro => {
            console.error('Erro na requisição:', erro);
        });
}

function formatarDataHora(dataHora) {
    if (!dataHora) return 'N/A';
    
    const data = new Date(dataHora);
    return data.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function iniciarAtualizacaoAutomatica(idSensor = 1, intervalo = 30000) {

    obterDadosKpi(idSensor);
    
    setInterval(() => {
        obterDadosKpi(idSensor);
    }, intervalo);
}


document.addEventListener('DOMContentLoaded', function() {
    iniciarAtualizacaoAutomatica(1);
});

  function grafico_de_linha() {
    const ctx = document.getElementById('canvas_grafico').getContext('2d');

    const labels = [
      '10:00', '10:10', '10:20', '10:30', '10:40', '10:50',
      '11:00', '11:10', '11:20', '11:30', '11:40'
    ];

    const data = {
      labels: labels,
      datasets: [{
        label: 'Nível de Gás (%)',
        data: [5, 10, 12, 15, 10, 14, 20, 18, 21, 23, 25],
        borderColor: 'rgba(54, 162, 235, 1)',        
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }]
    };

    const config = {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 25 
          }
        },
        plugins: {
          legend: {
            display: true
          }
        }
      }
    };

    chart = new Chart(ctx, config);
  }
</script>