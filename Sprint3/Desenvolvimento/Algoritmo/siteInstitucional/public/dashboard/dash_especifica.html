<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/dash_especifica.css">
  <link rel="stylesheet" href="../css/navbar.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.1.1/dist/chartjs-plugin-annotation.min.js"></script>
  <title>Dashboard Específica</title>
</head>

<body onload="grafico_de_linha()"> <!-- Carrega o gráfico de linha -->

  <div class="main"> <!-- Contêiner principal -->
    <div class="navbar"> <!-- Barra lateral de Menu -->
      <div class="welcome_navbar">
        <h5>Olá, <span id="span_nome_condominio"></span>!</h5>
        <h5>Bem-vindo de volta.</h5>
      </div>

      <div class="container_btn">
        <div class="btnNavbar">
          <img src="../assets/icons_navbar/predio_icon.png">
          <a href="Dash_Geral.html">Dashboard Geral</a> <!-- Ir para Dashboard Geral -->
        </div>

        <div class="btnNavbar">
          <img src="../assets/icons_navbar/predio_icon.png">
          <a href="dash_historico.html">Histórico de Alertas</a> <!-- Ir para Histórico -->
        </div>

        <div class="btnNavbar">
          <img src="../assets/icons_navbar/predio_icon.png">
          <a href="dash_portarias.html">Portaria</a> <!-- Ir para Dashboard Portaria -->
        </div>

      </div>
      <div class="btnNavbar">
        <img src="../assets/icons_navbar/logout.png">
        <a href="../login.html">Logout</a> <!-- Sair do Login -->
      </div>
    </div>

    <main class="painel"> <!-- Painel do todo conteúdo -->
      <div class="container_superior">
        <div class="div_kpi indicador_acao">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_acao.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Ação Rápida</span> <!-- KPI Ação -->
            <span class="span_resposta" id="span_alerta_acao"></span>
          </div>
        </div>

        <div class="div_kpi indicador_status">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_status.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Status de Alerta</span> <!-- KPI Status de Alerta -->
            <span class="span_resposta span_alerta_status"></span>
          </div>
        </div>

        <div class="div_kpi indicador_local">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_local.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">No Local</span> <!-- KPI Local que está anormal e com maior nível de gás -->
            <span class="span_resposta" id="span_local_medicaoMaior"></span>
          </div>
        </div>

        <div class="div_kpi indicador_hora">
          <div class="div_icon">
            <img src="../assets/dashEspecifica/icon_atualizacao.png" alt="">
          </div>
          <div class="div_informacao">
            <span class="span_titulo">Última Atualização</span>
            <!-- KPI Última data e hora quando maior nível de gás -->
            <span class="span_resposta" id="span_dataHora"></span>
          </div>
        </div>

      </div>

      <div class="container_inferior">
        <div class="div_grafico"> <!-- Gráfico de medição de um sensor selecionado -->
          <div class="div_nivel">
            <span class="span_titulo">Nivel de Gás (Últimas 2h)</span>
            <span class="span_identificacao">Torre <span id="span_bloco_predio"></span>, Apto <span
                id="span_numero_apartamento"></span>, <span id="span_sensor_local_selecionado"></span></span>
            <hr>
            <canvas id="canvas_grafico"></canvas>
          </div>
        </div>

        <div class="div_sensores">
          <div class="div_alerta">

            <div class="div_status_alerta">
              <div class="div_img_alerta">
                <img src="../assets/dashEspecifica/icon_alerta.png" alt="">
              </div>
              <div class="div_sobre_alerta">
                <span class="span_titulo">Alerta de Risco<span class="span_alerta_status"></span></span>
                <!-- KPI Alerta com Risco -->
                <span class="span_subtitulo" id="span_alerta_risco"></span>
              </div>
            </div>

          </div>
          <div class="div_medicao">
            <div class="div_titulo_medicao">
              <span class="span_titulo">Sensores</span> <!-- Seleção de sensores do apartamento -->
              <span class="span_subtitulo">NIVEL DE GÁS (%)</span>
            </div>
            <hr>

            <div class="div_sensores_medicao">
              <div class="div_opcao_sensor"> <!-- Seleção de sensor 1 -->
                <span class="span_sensor" id="span_local_sensor1">--------</span>
                <span class="span_medicao" id="span_medicao1">--------</span>
                <button class="btn_sensor" id="btn_sensor1">Ver Gráfico</button>
              </div>
              <hr>

              <div class="div_opcao_sensor"> <!-- Seleção de sensor 2 -->
                <span class="span_sensor" id="span_local_sensor2">--------</span>
                <span class="span_medicao" id="span_medicao2">--------</span>
                <button class="btn_sensor" id="btn_sensor2">Ver Gráfico</button>
              </div>
              <hr>

              <div class="div_opcao_sensor"> <!-- Seleção de sensor 3 -->
                <span class="span_sensor" id="span_local_sensor3">--------</span>
                <span class="span_medicao" id="span_medicao3">--------</span>
                <button class="btn_sensor" id="btn_sensor3">Ver Gráfico</button>
              </div>

            </div>
          </div>
        </div>
      </div>

  </div>
  </main>

</body>

</html>
<script>

const nomesSensores = ["Sala", "Quarto", "Cozinha"];


  // Recupera o número do apartamento do localStorage
  var numero_apartamento = localStorage.getItem("numero_apartamento");  
  // e exibe na span_numero_apartamento
  document.getElementById("span_numero_apartamento").innerText = numero_apartamento;

  var sensores_estaticos = {
    sensor2: {
      local: "Cozinha",
      nivel: 5.2
    },
    sensor3: {
      local: "Quarto",
      nivel: 14.8
    }
  };

  function obterCorPorNivel(nivel) {
    if (nivel <= 2.4) {
      return "#22c55e"; // Verde
    } else if (nivel <= 4.9) {
      return "#eab308"; // Amarelo
    } else if (nivel <= 14.9) {
      return "#ef4444"; 
    } else {
      return "#7f1d1d"; 
    }
  }


  var sensorGraficoAtual = null;
  var primeiraExecucao = true;


  function atualizarSensoresEstaticos() {
    // Sensor 2 - Cozinha
    var variacao2 = (Math.random() - 0.5) * 0.6; // Variação de -0.3 a +0.3
    sensores_estaticos.sensor2.nivel = Math.max(0, sensores_estaticos.sensor2.nivel + variacao2);
    sensores_estaticos.sensor2.nivel = Math.round(sensores_estaticos.sensor2.nivel * 10) / 10;

    // Sensor 3 - Quarto
    var variacao3 = (Math.random() - 0.5) * 0.4; // Variação de -0.2 a +0.2
    sensores_estaticos.sensor3.nivel = Math.max(0, sensores_estaticos.sensor3.nivel + variacao3);
    sensores_estaticos.sensor3.nivel = Math.round(sensores_estaticos.sensor3.nivel * 10) / 10;
  }

  // Carrega os dados do KPI de alerta e título do gráfico
  document.addEventListener("DOMContentLoaded", retornar_dados_kpi_alerta);
  // quando a página é carregada e a cada 5 segundos
  setInterval(retornar_dados_kpi_alerta, 5000);

  // Função para retornar os dados do alerta das KPIs de Status, Ação e Risco
  function retornar_dados_kpi_alerta() {
    fetch(`/alerta/retornar?numero_apartamento=${numero_apartamento}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(resposta => resposta.json())
      .then(data => {
        document.getElementById("span_alerta_acao").innerText = data.acao;
        document.querySelectorAll('.span_alerta_status').forEach(span => {
          span.innerText = data.statusAlerta;
        });
        document.getElementById("span_alerta_risco").innerText = data.risco;
      })
      .catch(erro => {
        console.log(`#ERRO: ${erro}`);
      });
      

    if (primeiraExecucao) {
      primeiraExecucao = false;
    }
  }

  function atualizarTextosBotoes() {
    for (let j = 1; j <= 3; j++) {
      const btn = document.getElementById(`btn_sensor${j}`);
      if (j === sensorGraficoAtual) {
        btn.innerText = "Gráfico Atual";
        btn.style.opacity = "0.8";
        btn.style.fontWeight = "bold";
      } else {
        btn.innerText = "Ver Gráfico";
        btn.style.opacity = "1";
        btn.style.fontWeight = "normal";
      }
    }
  }

  document.addEventListener("DOMContentLoaded", retornar_dados_tituloGrafico);
  setInterval(retornar_dados_tituloGrafico, 5000);

  function retornar_dados_tituloGrafico() {
    fetch(`/predio/retornar?numero_apartamento=${numero_apartamento}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then(resposta => resposta.json())
      .then(data => {
        document.getElementById("span_bloco_predio").innerText = data.bloco_predio;
      })
      .catch(erro => {
        console.log(`#ERRO: ${erro}`);
      });
  }


  function formatarDataHora(dataHoraStr) {
    if (!dataHoraStr) return "";

    var meses = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];
    var dataHora = new Date(dataHoraStr.replace(" ", "T"));

    var agora = new Date();
    var hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
    var data = new Date(dataHora.getFullYear(), dataHora.getMonth(), dataHora.getDate());

    var diffDias = Math.floor((hoje - data) / (1000 * 60 * 60 * 24));

    var hora = dataHora.getHours().toString().padStart(2, "0");
    var min = dataHora.getMinutes().toString().padStart(2, "0");

    if (diffDias === 0) {
      return `Hoje, ${hora}:${min}`;
    } else if (diffDias === 1) {
      return `Ontem, ${hora}:${min}`;
    } else {
      return `${data.getDate()} ${meses[data.getMonth()]}, ${hora}:${min}`;
    }
  }


// ...existing code...

function retornar_dados_niveisEmLocais() {
  // Sensor 1 (Sala) - busca do banco
  fetch(`/sensor/por-apartamento?numero_apartamento=${numero_apartamento}`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then(resposta => resposta.json())
    .then(data => {
      // Procura o sensor com idSensor = 1
      const sensorSala = data.find(item => item.idSensor == 1);
      document.getElementById("span_local_sensor1").innerText = nomesSensores[0];
      if (sensorSala) {
        document.getElementById("span_medicao1").innerText = sensorSala.nivel_de_gas + " %";
        document.getElementById("btn_sensor1").style.backgroundColor = obterCorPorNivel(sensorSala.nivel_de_gas);
        document.getElementById("span_local_medicaoMaior").innerText = nomesSensores[0];
        document.getElementById("span_dataHora").innerText = formatarDataHora(sensorSala.data_hora);
        if (primeiraExecucao) {
          sensorGraficoAtual = 1;
          document.getElementById("span_sensor_local_selecionado").innerText = nomesSensores[0];
          atualizarGraficoParaSensor(1);
        }
      } else {
        document.getElementById("span_medicao1").innerText = "-- %";
        document.getElementById("btn_sensor1").style.backgroundColor = "#ccc";
        document.getElementById("span_local_medicaoMaior").innerText = nomesSensores[0];
        document.getElementById("span_dataHora").innerText = "--";
      }

      // Sensores 2 e 3 - simulados
      atualizarSensoresEstaticos();
      document.getElementById("span_local_sensor2").innerText = nomesSensores[1];
      document.getElementById("span_medicao2").innerText = sensores_estaticos.sensor2.nivel + " %";
      document.getElementById("btn_sensor2").style.backgroundColor = obterCorPorNivel(sensores_estaticos.sensor2.nivel);

      document.getElementById("span_local_sensor3").innerText = nomesSensores[2];
      document.getElementById("span_medicao3").innerText = sensores_estaticos.sensor3.nivel + " %";
      document.getElementById("btn_sensor3").style.backgroundColor = obterCorPorNivel(sensores_estaticos.sensor3.nivel);

      atualizarTextosBotoes();
    })
    .catch(erro => {
      console.log(`#ERRO: ${erro}`);
    });
}

// ...existing code...

function atualizarGraficoParaSensor(sensorNum) {
  if (sensorNum === 1) {
    // Sensor 1 - dados do banco
    grafico_de_linha();
  } else {
    // Sensores 2 e 3 - dados aleatórios
    var dadosAleatorios = gerarDadosAleatorios(sensorNum);

    const labels = dadosAleatorios.map(item => item.data_hora);
    const valores = dadosAleatorios.map(item => item.nivel_de_gas);

    if (canvas_grafico) {
      canvas_grafico.data.labels = labels;
      canvas_grafico.data.datasets[0].data = valores;
      canvas_grafico.options.scales.y.max = Math.max(Math.max(...valores), 5) + 2;
      canvas_grafico.update();
    } else {
      criarGrafico(labels, valores);
    }
  }
}

// ...existing code...

function grafico_de_linha() {
  fetch(`/grafico/medicoes-gas?sensor=1&numero_apartamento=${numero_apartamento}`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then(resposta => resposta.json())
    .then(data => {
      const agora = new Date();
      const duasHorasAtras = new Date(agora.getTime() - 2 * 60 * 60 * 1000);

      // Labels de 5 em 5 minutos
      let labels = [];
      let timeCursor = new Date(duasHorasAtras);
      while (timeCursor <= agora) {
        labels.push(
          timeCursor.getHours().toString().padStart(2, "0") + ":" +
          timeCursor.getMinutes().toString().padStart(2, "0")
        );
        timeCursor = new Date(timeCursor.getTime() + 5 * 60000); // +5 minutos
      }

      // Ordena e filtra os dados recebidos
      const ordenados = data
        .map(item => ({
          ...item,
          dataObj: new Date(item.data_hora.replace(" ", "T"))
        }))
        .filter(item => item.dataObj >= duasHorasAtras && item.dataObj <= agora)
        .sort((a, b) => a.dataObj - b.dataObj);

      // Para cada label, pega o valor mais próximo (até 3 minutos de diferença)
      const valores = labels.map(label => {
        const [h, m] = label.split(":");
        const labelDate = new Date(agora);
        labelDate.setHours(h, m, 0, 0);

        let closest = null;
        let minDiff = 4 * 60 * 1000; // 4 minutos em ms
        for (const item of ordenados) {
          const diff = Math.abs(item.dataObj - labelDate);
          if (diff < minDiff) {
            minDiff = diff;
            closest = item;
          }
        }
        return closest ? closest.nivel_de_gas : null;
      });

      // Atualiza o botão e a medição do sensor 1 com o último valor real
      const ultimoValor = [...valores].reverse().find(v => v !== null);
      if (ultimoValor !== undefined) {
        document.getElementById("span_medicao1").innerText = ultimoValor + " %";
        document.getElementById("btn_sensor1").style.backgroundColor = obterCorPorNivel(ultimoValor);
      }

      if (canvas_grafico) {
        canvas_grafico.data.labels = labels;
        canvas_grafico.data.datasets[0].data = valores;
        canvas_grafico.options.scales.y.max = Math.max(Math.max(...valores.filter(v => v !== null)), 5) + 2;
        canvas_grafico.update();
      } else {
        criarGrafico(labels, valores);
      }
    })
    .catch(erro => {
      console.error("Erro ao buscar dados do gráfico:", erro);
      if (!canvas_grafico) {
        criarGrafico([], []);
      }
    });
}

  document.addEventListener("DOMContentLoaded", retornar_dados_niveisEmLocais);
  // quando a página é carregada e a cada 5 segundos
  setInterval(retornar_dados_niveisEmLocais, 5000);

  document.addEventListener("DOMContentLoaded", function () {
    function configurarBotoesSensores() {
      for (let i = 1; i <= 3; i++) {
        const btn = document.getElementById(`btn_sensor${i}`);
        btn.addEventListener("click", function () {

          sensorGraficoAtual = i;
          
          // Atualiza o span com o local do sensor clicado
          const local = document.getElementById(`span_local_sensor${i}`).innerText;
          document.getElementById("span_sensor_local_selecionado").innerText = local;

          // Atualiza os textos dos botões
          atualizarTextosBotoes();
          
          // Atualizar o gráfico para o sensor selecionado
          atualizarGraficoParaSensor(i);
        });
      }
    }

    configurarBotoesSensores();
  });

  // Função para gerar dados aleatórios para sensores estáticos
 function gerarDadosAleatorios(sensorNum, horasAtras = 2) {
  var dados = [];
  var agora = new Date();
  var nivelBase = sensorNum === 2 ? sensores_estaticos.sensor2.nivel : sensores_estaticos.sensor3.nivel;

  for (let i = horasAtras * 12; i >= 0; i--) { // Troque 12 por 24 para 5min
    var tempo = new Date(agora.getTime() - (i * 5 * 60000)); // 5 minutos de intervalo
    var hora = tempo.getHours().toString().padStart(2, "0");
    var minuto = tempo.getMinutes().toString().padStart(2, "0");

    var variacao = (Math.random() - 0.5) * (nivelBase * 0.3);
    var nivel = Math.max(0, nivelBase + variacao);
    nivel = Math.round(nivel * 10) / 10;

    dados.push({
      data_hora: `${hora}:${minuto}`,
      nivel_de_gas: nivel
    });
  }

  return dados;
}

  // Função para atualizar gráfico baseado no sensor selecionado
  function atualizarGraficoParaSensor(sensorNum) {
    if (sensorNum === 1) {
      // Sensor 1 - dados do banco
      grafico_de_linha();
    } else {
      // Sensores 2 e 3 - dados aleatórios
      var dadosAleatorios = gerarDadosAleatorios(sensorNum);
      
      const labels = dadosAleatorios.map(item => item.data_hora);
      const valores = dadosAleatorios.map(item => item.nivel_de_gas);

      if (canvas_grafico) {
        canvas_grafico.data.labels = labels;
        canvas_grafico.data.datasets[0].data = valores;
        canvas_grafico.options.scales.y.max = Math.max(Math.max(...valores), 5) + 2;
        canvas_grafico.update();
      }
    }
  }

var canvas_grafico;



function criarGrafico(labels, valores) {
  if (canvas_grafico) {
    canvas_grafico.destroy();
  }
  const ctx = document.getElementById('canvas_grafico').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 500);
  gradient.addColorStop(0, 'rgba(37, 99, 235, 0.5)');
  gradient.addColorStop(0.5, 'rgba(37, 99, 235, 0.01)');
  gradient.addColorStop(0.6, 'rgba(37, 99, 235, 0.01)');
  gradient.addColorStop(0.6, 'rgb(255, 255, 255)');


  if (window.Chart && window.Chart.register && window['ChartAnnotation']) {
  Chart.register(window['ChartAnnotation']);
}

  canvas_grafico = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Nível de Gás (%)',
        data: valores,
        fill: true,
        backgroundColor: gradient,
        borderColor: '#2563eb',
        tension: 0.3,
        pointRadius: 4,
        pointBackgroundColor: '#2563eb'
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: Math.max(Math.max(...valores), 15) + 2
        }
      },
      plugins: {
        annotation: {
          annotations: {
            LIE: {
              type: 'line',
              yMin: 5,
              yMax: 5,
              borderColor: 'red',
              borderWidth: 2,
              label: {
                enabled: true,
                content: 'LIE',
                position: 'end',
                color: 'red',
                font: { weight: 'bold' }
              }
            },
            LSE: {
              type: 'line',
              yMin: 15,
              yMax: 15,
              borderColor: 'black',
              borderWidth: 2,
              label: {
                enabled: true,
                content: 'LSE',
                position: 'end',
                color: 'black',
                font: { weight: 'bold' }
              }
            }
          }
        }
      }
    }
  });
}

var sensorGraficoAtual = 1; // Começa mostrando o sensor 1
var primeiraExecucao = true;

// ...todas as funções...

// Atualiza o gráfico do sensor 1 em tempo real
setInterval(() => {
  if (sensorGraficoAtual === 1) {
    grafico_de_linha();
  }
}, 1000);
// ...existing code...


</script>